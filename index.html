<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%">

<head>

<title>VKGeo</title>
<meta charset="UTF-8">

<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">

<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="https://vk.com/js/api/xd_connection.js?2"></script>

</head>

<body style="width: 100%; height: 100%">

<div id="map" style="width: 100%; height: 100%"></div>

<script>
    function fitMapToAllMarkers() {
        var markers = marker_source.getFeatures();

        if (markers.length > 0) {
            var extent = [0.0, 0.0, 0.0, 0.0];

            for (var i = 0; i < markers.length; i++) {
                ol.extent.extend(extent, markers[i].getGeometry().getExtent());
            }

            map.getView().fit(extent);
        }
    }

    VK.init(function() {
        console.log("SUCCESS");
    }, function() {
        console.log("FAILURE");
    },'5.78');

    VK.callMethod("showSettingsBox", 2050);

    var marker_source = new ol.source.Vector({
        features: []
    });

    var map = new ol.Map({
        target: "map",
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            }),
            new ol.layer.Vector({
                source: marker_source
            })
        ],
        view:   new ol.View({
            center: ol.proj.fromLonLat([0.0, 0.0]),
            zoom: 0
        })
    });

    var my_marker = null;

    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(function(position) {
            if (my_marker === null) {
                VK.api("users.get", {
                    "fields": "photo_50",
                    "v":      "5.76"
                }, function (data) {
                    if (data.response.length === 1) {
                        my_marker = new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude])),
                        });

                        my_marker.setStyle(new ol.style.Style({
                            image: new ol.style.Icon({
                                src: data.response[0].photo_50,
                            })
                        }));

                        marker_source.addFeature(my_marker);

                        fitMapToAllMarkers();
                    } else {
                        console.log("users.get : invalid response : " + data);
                    }
                });
            } else {
                my_marker.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude])));
            }
        });
    }
</script>

</body>

</html>
