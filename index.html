<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%">

<head>

<title>VKGeo</title>
<meta charset="UTF-8">

<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">

<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="https://www.localeplanet.com/api/auto/icu.js"></script>
<script src="https://www.localeplanet.com/api/translate.js"></script>
<script src="https://vk.com/js/api/xd_connection.js?2"></script>
<script src="qmlweb/qmlweb.js"></script>

</head>

<body style="width: 100%; height: 100%">

<div id="map" style="width: 100%; height: 100%"></div>
<div id="controlPanel" style="margin: auto; position: absolute; width: 80px; top: 10%; right: 0; bottom: 10%; z-index: 1; display: none"></div>
<div id="fatalErrorMessage" style="margin: auto; position: absolute; left: 25%; top: 35%; right: 25%; bottom: 35%; z-index: 2; display: none"></div>

<script>
    const UPDATE_INTERVAL     = 60000;
    const VK_REQUEST_INTERVAL = 500;
    const VK_MAX_BATCH_SIZE   = 25;
    const VK_API_V            = "5.78";
    const DATA_NOTE_TITLE     = "VKGeo Data";

    function displayFatalError(error_text) {
        let fem_div = document.getElementById("fatalErrorMessage");

        fem_div.style.display = "block";

        let fem_qml_engine = new QmlWeb.QMLEngine(fem_div);

        fem_qml_engine.loadFile("qml/FatalErrorMessage.qml");

        fem_qml_engine.rootObject.errorText = error_text;

        fem_qml_engine.start();
    }

    function fitMapToAllMarkers() {
        let markers = marker_source.getFeatures();

        if (markers.length > 0) {
            let extent = [0.0, 0.0, 0.0, 0.0];

            for (let i = 0; i < markers.length; i++) {
                ol.extent.extend(extent, markers[i].getGeometry().getExtent());
            }

            map.getView().fit(extent);
        }
    }

    function startPeriodicUpdates() {
        let notes_req_count = 0;
        let friends_list    = [];
        let friends_map     = {};
        let notes_list      = [];

        function updateFriends(data, offset) {
            if (data.hasOwnProperty("response")) {
                friends_list = friends_list.concat(data.response.items);

                if (offset + data.response.items.length < data.response.count) {
                    setTimeout(function() {
                        VK.api("friends.get", {
                            "fields": "photo_50,photo_100",
                            "offset": offset + data.response.items.length,
                            "v":      VK_API_V
                        }, function(data) {
                            updateFriends(data, offset + data.response.items.length);
                        });
                    }, VK_REQUEST_INTERVAL);
                } else {
                    for (let i = 0; i < friends_list.length; i = i + VK_MAX_BATCH_SIZE) {
                        let code = "var result = [];";

                        for (let j = 0; j < VK_MAX_BATCH_SIZE; j++) {
                            if (i + j < friends_list.length) {
                                friends_map[friends_list[i + j].id.toString()] = friends_list[i + j];

                                code = code + "result.push(API.notes.get({\"user_id\": " + friends_list[i + j].id + ", \"count\": 100}).items);";
                            }
                        }

                        code = code + "return result;"

                        setTimeout(function() {
                            VK.api("execute", {
                                "code": code,
                                "v":    VK_API_V
                            }, function(data) {
                                if (data.hasOwnProperty("response")) {
                                    for (let i = 0; i < data.response.length; i++) {
                                        for (let j = 0; j < data.response[i].length; j++) {
                                            if (data.response[i][j].title === DATA_NOTE_TITLE) {
                                                notes_list.push(data.response[i][j]);
                                            }
                                        }
                                    }
                                } else {
                                    if (data.hasOwnProperty("error")) {
                                        console.log("execute(notes.get) : invalid response : " + data.error.error_msg);
                                    } else {
                                        console.log("execute(notes.get) : invalid response : " + data);
                                    }
                                }

                                notes_req_count--;

                                if (notes_req_count === 0) {
                                    console.log(notes_list);

                                    //friendsListModel.clear();

                                    for (let i = 0; i < notes_list.length; i++) {
                                        let user_id = notes_list[i].owner_id.toString();

                                        if (friends_map.hasOwnProperty(user_id)) {
                                            let frnd = {};

                                            frnd.userId      = user_id;
                                            frnd.firstName   = friends_map[user_id].first_name;
                                            frnd.lastName    = friends_map[user_id].last_name;
                                            frnd.photoUrl    = friends_map[user_id].photo_50;
                                            frnd.bigPhotoUrl = friends_map[user_id].photo_100;

                                            //friendsListModel.append(frnd);
                                        }
                                    }
                                }
                            });
                        }, VK_REQUEST_INTERVAL * i / VK_MAX_BATCH_SIZE);

                        notes_req_count++;
                    }
                }
            } else {
                if (data.hasOwnProperty("error")) {
                    console.log("friends.get : invalid response : " + data.error.error_msg);
                } else {
                    console.log("friends.get : invalid response : " + data);
                }
            }
        }

        VK.api("friends.get", {
            "fields": "photo_50,photo_100",
            "v":      VK_API_V
        }, function(data) {
            updateFriends(data, 0);
        });

        setTimeout(startPeriodicUpdates, UPDATE_INTERVAL);
    }

    var marker_source = new ol.source.Vector({
        features: []
    });

    var map = new ol.Map({
        target: "map",
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            }),
            new ol.layer.Vector({
                source: marker_source
            })
        ],
        view:   new ol.View({
            center: ol.proj.fromLonLat([0.0, 0.0]),
            zoom: 0
        })
    });

    var my_marker = null;

    VK.init(function() {
        VK.addCallback("onSettingsChanged", function(settings) {
            startPeriodicUpdates();

            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(function(position) {
                    if (my_marker === null) {
                        VK.api("users.get", {
                            "fields": "photo_50",
                            "v":      VK_API_V
                        }, function(data) {
                            if (data.hasOwnProperty("response") && data.response.length === 1) {
                                my_marker = new ol.Feature({
                                    geometry: new ol.geom.Point(ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude])),
                                });

                                my_marker.setStyle(new ol.style.Style({
                                    image: new ol.style.Icon({
                                        src: data.response[0].photo_50,
                                    })
                                }));

                                marker_source.addFeature(my_marker);

                                fitMapToAllMarkers();
                            } else {
                                if (data.hasOwnProperty("error")) {
                                    console.log("users.get : invalid response : " + data.error.error_msg);
                                } else {
                                    console.log("users.get : invalid response : " + data);
                                }
                            }
                        });
                    } else {
                        my_marker.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude])));
                    }
                });
            }
        });
        VK.addCallback("onSettingsCancel", function() {
            displayFatalError(_("You should allow access to friends and notes to view location of your friends on the map"));
        });

        VK.callMethod("showSettingsBox", 2050);
    }, function() {
        displayFatalError(_("VK initialization failed"));
    }, VK_API_V);
</script>

</body>

</html>
