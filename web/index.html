<!DOCTYPE html>
<html lang="en">
    <head>
        <title>VKGeo</title>

        <meta charset="UTF-8">

        <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
        <link rel="stylesheet" href="style.css">

        <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
        <script src="https://www.localeplanet.com/api/auto/icu.js"></script>
        <script src="https://www.localeplanet.com/api/translate.js"></script>
        <script src="https://vk.com/js/api/xd_connection.js?2"></script>
    </head>
    <body>
        <div id="map"></div>
        <div id="markerTooltip">
            <p id="markerTooltipNameText"></p>
            <p id="markerTooltipUpdateTimeText"></p>
        </div>
        <div id="controlPanel"></div>
        <div id="invitationPanel">
            <p id="invitationPanelText"></p>
        </div>
        <div id="settingsPanel">
            <p id="settingsPanelText"></p>
            <button id="settingsPanelButton" onClick="requestSettings()"></button>
        </div>
        <div id="fatalErrorPanel">
            <p id="fatalErrorPanelText"></p>
        </div>

        <script>
            function escapeHtml(string) {
                var text = document.createTextNode(string);
                var div  = document.createElement("div");

                div.appendChild(text);

                return div.innerHTML;
            }

            function getUrlParameter(name) {
                name = name.replace(/[\[\]]/g, "\\$&");

                var regex   = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
                var results = regex.exec(window.location.href);

                if (results) {
                    if (results[2]) {
                        return decodeURIComponent(results[2].replace(/\+/g, " "));
                    } else {
                        return "";
                    }
                } else {
                    return null;
                }
            }

            function displayFatalError(error_text) {
                document.getElementById("fatalErrorPanelText").innerHTML = escapeHtml(error_text);

                document.getElementById("fatalErrorPanel").style.display = "flex";
            }

            function loadMainScript() {
                try {
                    eval("const c = 1; let v = (x) => x + c; let l = (new URL(document.location)).searchParams.get(\"language\");");

                    var app_script = document.createElement("script");

                    app_script.src = "vkgeo.js";

                    document.getElementsByTagName("head")[0].appendChild(app_script);
                } catch (err) {
                    displayFatalError(_("Please update your browser to start using this app."));
                }
            }

            document.addEventListener("DOMContentLoaded", function() {
                var language = getUrlParameter("language");

                if (language !== null) {
                    var lng_value  = parseInt(language, 10);
                    var lng_script = document.createElement("script");

                    if (lng_value < 3) {
                        lng_script.src    = "translations/vkgeo_ru.js";
                        lng_script.onload = loadMainScript;

                        document.getElementsByTagName("head")[0].appendChild(lng_script);
                    } else {
                        loadMainScript();
                    }
                } else {
                    loadMainScript();
                }
            });
        </script>
    </body>
</html>
